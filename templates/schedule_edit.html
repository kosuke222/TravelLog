{% extends "base.html" %}

{% block content %}
  <section class="page-header">
    <div>
      <p class="eyebrow">Edit</p>
      <h1>プランを編集</h1>
      <p class="lead">タイトルやメモ、写真を更新できます。</p>
    </div>
  </section>

  <section class="panel form-panel">
    <form method="post" action="{{ url_for('schedule_update', schedule_id=schedule['id']) }}" class="form-grid" enctype="multipart/form-data">
      <div>
        <label for="title">タイトル</label>
        <input id="title" name="title" type="text" value="{{ schedule['title'] }}" />
      </div>
      <div>
        <label for="date">日付</label>
        <input id="date" name="date" type="date" value="{{ schedule['date'] or '' }}" />
      </div>
      <div>
        <label for="start_time">開始時刻</label>
        <input id="start_time" name="start_time" type="time" value="{{ schedule['start_time'] or '' }}" />
      </div>
      <div>
        <label for="end_time">終了時刻</label>
        <input id="end_time" name="end_time" type="time" value="{{ schedule['end_time'] or '' }}" />
      </div>
      <div>
        <label for="detail">メモ</label>
        <textarea id="detail" name="detail">{{ schedule['detail'] or '' }}</textarea>
      </div>
      <div>
        <label for="address">住所</label>
        <input id="address" name="address" type="text" value="{{ schedule['address'] or '' }}" />
      </div>
      <div>
        <label for="photos">画像を追加</label>
        <input id="photos" name="photos" type="file" accept="image/*" multiple />
        {% if schedule["photo_url"] or photos %}
          <div class="photo-shell">
            <div class="photo-scroller">
              {% if schedule["photo_url"] %}
                {% set raw_url = schedule["photo_url"] %}
                {% if raw_url.startswith('google-ref:') and google_maps_api_key %}
                  {% set ref = raw_url[11:] %}
                  {% set display_url = 'https://maps.googleapis.com/maps/api/place/photo?maxwidth=600&photo_reference=' ~ ref ~ '&key=' ~ google_maps_api_key %}
                {% else %}
                  {% set display_url = raw_url %}
                {% endif %}
                <img class="place-photo preview" src="{{ display_url }}" alt="{{ schedule['title'] }}" />
              {% endif %}
              {% for photo in photos %}
                {% set raw_url = photo['photo_url'] %}
                {% if raw_url.startswith('google-ref:') and google_maps_api_key %}
                  {% set ref = raw_url[11:] %}
                  {% set display_url = 'https://maps.googleapis.com/maps/api/place/photo?maxwidth=600&photo_reference=' ~ ref ~ '&key=' ~ google_maps_api_key %}
                {% else %}
                  {% set display_url = raw_url %}
                {% endif %}
                <img class="place-photo preview" src="{{ display_url }}" alt="{{ schedule['title'] }}" />
              {% endfor %}
            </div>
          </div>
        {% endif %}
      </div>

      <input type="hidden" id="place_id" name="place_id" value="{{ schedule['place_id'] or '' }}" />
      <input type="hidden" id="lat" name="lat" value="{{ schedule['lat'] or '' }}" />
      <input type="hidden" id="lng" name="lng" value="{{ schedule['lng'] or '' }}" />
      <input type="hidden" id="photo_url" name="photo_url" value="{{ schedule['photo_url'] or '' }}" />
      <input type="hidden" id="photo_urls" name="photo_urls" />
      <input type="hidden" id="rating" name="rating" value="{{ schedule['rating'] or '' }}" />
      <input type="hidden" id="user_ratings_total" name="user_ratings_total" value="{{ schedule['user_ratings_total'] or '' }}" />
      <input type="hidden" id="website" name="website" value="{{ schedule['website'] or '' }}" />
      <input type="hidden" id="phone" name="phone" value="{{ schedule['phone'] or '' }}" />
      <input type="hidden" id="google_url" name="google_url" value="{{ schedule['google_url'] or '' }}" />
      <input type="hidden" id="opening_hours" name="opening_hours" value="{{ schedule['opening_hours'] or '' }}" />

      <div class="inline-actions">
        <button class="button primary" type="submit">更新する</button>
        <a class="button ghost" href="{{ url_for('schedule') }}">戻る</a>
      </div>
    </form>
  </section>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const input = document.getElementById("photos");
      if (!input) return;
      const MAX_IMAGE_BYTES = 1_500_000;
      const MAX_IMAGE_DIMENSION = 1600;

      const compressImage = async (file) => {
        if (!file.type.startsWith("image/")) {
          return file;
        }
        if (file.size <= MAX_IMAGE_BYTES) {
          return file;
        }
        const imageUrl = URL.createObjectURL(file);
        try {
          const img = new Image();
          await new Promise((resolve, reject) => {
            img.onload = resolve;
            img.onerror = reject;
            img.src = imageUrl;
          });
          const scale = Math.min(1, MAX_IMAGE_DIMENSION / Math.max(img.width, img.height));
          const canvas = document.createElement("canvas");
          canvas.width = Math.round(img.width * scale);
          canvas.height = Math.round(img.height * scale);
          const ctx = canvas.getContext("2d");
          if (!ctx) return file;
          ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
          let quality = 0.82;
          let blob = await new Promise((resolve) =>
            canvas.toBlob(resolve, "image/jpeg", quality)
          );
          while (blob && blob.size > MAX_IMAGE_BYTES && quality > 0.6) {
            quality -= 0.08;
            blob = await new Promise((resolve) =>
              canvas.toBlob(resolve, "image/jpeg", quality)
            );
          }
          if (!blob) return file;
          return new File([blob], file.name.replace(/\.[^/.]+$/, "") + ".jpg", {
            type: "image/jpeg",
          });
        } finally {
          URL.revokeObjectURL(imageUrl);
        }
      };

      input.addEventListener("change", async () => {
        if (!input.files || input.files.length === 0) return;
        const dt = new DataTransfer();
        for (const file of input.files) {
          const next = await compressImage(file);
          if (next.size > MAX_IMAGE_BYTES) {
            alert("画像サイズが大きすぎます。1.5MB以下にしてください。");
            return;
          }
          dt.items.add(next);
        }
        input.files = dt.files;
      });
    });
  </script>
{% endblock %}
