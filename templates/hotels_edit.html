{% extends "base.html" %}

{% block head %}
  {% if google_maps_api_key %}
    <script>
      function initHotelEditSearch() {
        const run = () => {
          const input = document.getElementById("hotel-search-input");
          const mapEl = document.getElementById("hotel-map");
          if (!input || !mapEl || !window.google || !google.maps || !google.maps.places) {
            return;
          }

          const autocomplete = new google.maps.places.Autocomplete(input, {
            fields: [
              "place_id",
              "name",
              "formatted_address",
              "geometry",
              "url",
              "website",
            ],
            types: ["lodging"],
          });

          const map = new google.maps.Map(mapEl, {
            center: { lat: 35.6804, lng: 139.769 },
            zoom: 12,
          });

          const marker = new google.maps.Marker({ map });

          autocomplete.addListener("place_changed", () => {
            const place = autocomplete.getPlace();
            if (!place.geometry || !place.geometry.location) {
              return;
            }

            map.setCenter(place.geometry.location);
            map.setZoom(16);
            marker.setPosition(place.geometry.location);

            const name = document.getElementById("name");
            const address = document.getElementById("address");
            const mapUrl = document.getElementById("map_url");
            const websiteUrl = document.getElementById("website_url");
            if (name) name.value = place.name || "";
            if (address) address.value = place.formatted_address || "";
            if (mapUrl) mapUrl.value = place.url || "";
            if (websiteUrl) websiteUrl.value = place.website || "";
          });
        };

        if (document.readyState === "loading") {
          document.addEventListener("DOMContentLoaded", run, { once: true });
        } else {
          run();
        }
      }
    </script>
    <script
      src="https://maps.googleapis.com/maps/api/js?key={{ google_maps_api_key }}&libraries=places&callback=initHotelEditSearch"
      async
      defer
    ></script>
  {% endif %}
{% endblock %}

{% block content %}
  <section class="page-header">
    <div>
      <p class="eyebrow">Edit</p>
      <h1>ホテルを編集</h1>
      <p class="lead">検索でホテル情報を更新できます。</p>
    </div>
  </section>

  <section class="panel form-panel">
    <form method="post" action="{{ url_for('hotels_update', hotel_id=hotel['id']) }}" class="form-grid" enctype="multipart/form-data">
      <div>
        <label for="hotel-search-input">ホテル名検索（Google Maps）</label>
        <input id="hotel-search-input" type="text" placeholder="例: 札幌 ○○ホテル" autocomplete="off" />
        {% if not google_maps_api_key %}
          <p class="meta">Google Maps APIキーが設定されていません。</p>
        {% endif %}
      </div>
      <div>
        <label for="name">ホテル名</label>
        <input id="name" name="name" type="text" value="{{ hotel['name'] }}" />
      </div>
      <div>
        <label for="address">住所</label>
        <input id="address" name="address" type="text" value="{{ hotel['address'] or '' }}" />
      </div>
      <div>
        <label for="checkin_date">宿泊開始日</label>
        <input id="checkin_date" name="checkin_date" type="date" value="{{ hotel['checkin_date'] or '' }}" />
      </div>
      <div>
        <label for="checkout_date">宿泊終了日</label>
        <input id="checkout_date" name="checkout_date" type="date" value="{{ hotel['checkout_date'] or '' }}" />
      </div>
      <div>
        <label>地図プレビュー</label>
        <div id="hotel-map" class="map-preview"></div>
      </div>
      <input id="map_url" name="map_url" type="hidden" value="{{ hotel['map_url'] or '' }}" />
      <div>
        <label for="website_url">公式サイト</label>
        <input id="website_url" name="website_url" type="url" value="{{ hotel['website_url'] or '' }}" />
      </div>
      <div>
        <label for="notes">メモ</label>
        <textarea id="notes" name="notes">{{ hotel['notes'] or '' }}</textarea>
      </div>
      <div>
        <label for="photos">画像を追加</label>
        <input id="photos" name="photos" type="file" accept="image/*" multiple />
        {% if photos %}
          <div class="photo-shell">
            <div class="photo-scroller">
              {% for photo in photos %}
                <img class="place-photo preview" src="{{ photo['photo_url'] }}" alt="{{ hotel['name'] }}" />
              {% endfor %}
            </div>
          </div>
        {% endif %}
      </div>
      <div class="inline-actions">
        <button class="button primary" type="submit">更新する</button>
        <a class="button ghost" href="{{ url_for('hotels') }}">戻る</a>
      </div>
    </form>
  </section>
{% endblock %}
