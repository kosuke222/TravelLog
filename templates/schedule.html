{% extends "base.html" %}

{% block head %}
  {% if google_maps_api_key %}
    <script>
      function initScheduleSearch() {
        const run = () => {
          const blocks = Array.from(document.querySelectorAll(".schedule-block"));
          const listMapEl = document.getElementById("schedule-list-map");
          const mapPanel = document.getElementById("schedule-map-panel");
          const mapClose = document.getElementById("schedule-map-close");
          if (!window.google || !google.maps || !google.maps.places) {
            return;
          }

          const initScheduleBlock = (block) => {
            const input = block.querySelector(".schedule-search-input");
            const mapEl = block.querySelector(".schedule-map");
            if (!input || !mapEl) {
              return;
            }

            const autocomplete = new google.maps.places.Autocomplete(input, {
              fields: [
                "place_id",
                "name",
                "formatted_address",
                "geometry",
                "photos",
                "types",
                "rating",
                "user_ratings_total",
                "website",
                "formatted_phone_number",
                "url",
                "opening_hours",
              ],
            });

            const map = new google.maps.Map(mapEl, {
              center: { lat: 35.6804, lng: 139.769 },
              zoom: 12,
            });

            const marker = new google.maps.Marker({ map });

            autocomplete.addListener("place_changed", () => {
              const place = autocomplete.getPlace();
              if (!place.geometry || !place.geometry.location) {
                return;
              }

              map.setCenter(place.geometry.location);
              map.setZoom(16);
              marker.setPosition(place.geometry.location);

              const address = block.querySelector(".schedule-address");
              const placeId = block.querySelector(".schedule-place-id");
              const lat = block.querySelector(".schedule-lat");
              const lng = block.querySelector(".schedule-lng");
              if (address) address.value = place.formatted_address || "";
              if (placeId) placeId.value = place.place_id || "";
              if (lat) lat.value = place.geometry.location.lat();
              if (lng) lng.value = place.geometry.location.lng();

              const previewImg = block.querySelector(".schedule-photo-preview");
              const previewMore = block.querySelector(".schedule-photo-more");
              const previewCount = block.querySelector(".schedule-photo-count");
              let photoUrl = "";
              let photoUrls = [];
              if (place.photos && place.photos.length > 0) {
                photoUrls = place.photos.slice(0, 6).map((photo) =>
                  photo.getUrl({ maxWidth: 600, maxHeight: 400 })
                );
                photoUrl = photoUrls[0] || "";
                if (previewImg) {
                  previewImg.src = photoUrl;
                  previewImg.classList.remove("is-hidden");
                }
                if (previewMore && previewCount) {
                  if (photoUrls.length > 1) {
                    previewCount.textContent = String(photoUrls.length);
                    previewMore.dataset.photos = JSON.stringify(photoUrls);
                    previewMore.classList.remove("is-hidden");
                  } else {
                    previewMore.classList.add("is-hidden");
                  }
                }
              } else {
                if (previewImg) previewImg.classList.add("is-hidden");
                if (previewMore) previewMore.classList.add("is-hidden");
              }
              const extractPhotoRef = (url) => {
                const refParam = url.match(/[?&]photo_reference=([^&]+)/);
                if (refParam && refParam[1]) return decodeURIComponent(refParam[1]);
                const refLegacy = url.match(/[?&]1s([^&]+)/);
                if (refLegacy && refLegacy[1]) return decodeURIComponent(refLegacy[1]);
                return "";
              };
              const photoRefs = photoUrls.map((url) => extractPhotoRef(url)).filter((ref) => ref);

              const photoUrlInput = block.querySelector(".schedule-photo-url");
              const photoUrlsInput = block.querySelector(".schedule-photo-urls");
              const photoRefsInput = block.querySelector(".schedule-photo-refs");
              if (photoUrlInput) photoUrlInput.value = photoUrl;
              if (photoUrlsInput) photoUrlsInput.value = JSON.stringify(photoUrls);
              if (photoRefsInput) photoRefsInput.value = JSON.stringify(photoRefs);

              const rating = block.querySelector(".schedule-rating");
              const userRatingsTotal = block.querySelector(".schedule-user-ratings-total");
              const website = block.querySelector(".schedule-website");
              const phone = block.querySelector(".schedule-phone");
              const googleUrl = block.querySelector(".schedule-google-url");
              const openingHours = block.querySelector(".schedule-opening-hours");
              if (rating) rating.value = place.rating || "";
              if (userRatingsTotal) userRatingsTotal.value = place.user_ratings_total || "";
              if (website) website.value = place.website || "";
              if (phone) phone.value = place.formatted_phone_number || "";
              if (googleUrl) googleUrl.value = place.url || "";
              const hours = place.opening_hours && place.opening_hours.weekday_text
                ? place.opening_hours.weekday_text.join("\n")
                : "";
              if (openingHours) openingHours.value = hours;
            });
          };

          blocks.forEach((block) => {
            initScheduleBlock(block);
          });
          window.__initScheduleBlock = initScheduleBlock;
          if (Array.isArray(window.__pendingScheduleBlocks) && window.__pendingScheduleBlocks.length) {
            window.__pendingScheduleBlocks.forEach((block) => {
              initScheduleBlock(block);
            });
            window.__pendingScheduleBlocks = [];
          }

          if (listMapEl && mapPanel) {
            const listMap = new google.maps.Map(listMapEl, {
              center: { lat: 35.6804, lng: 139.769 },
              zoom: 12,
            });
            const listMarker = new google.maps.Marker({ map: listMap });
            const infoWindow = new google.maps.InfoWindow();

            const cards = Array.from(document.querySelectorAll(".schedule-card"));
            cards.forEach((card) => {
              const lat = parseFloat(card.dataset.lat || "");
              const lng = parseFloat(card.dataset.lng || "");
              if (Number.isNaN(lat) || Number.isNaN(lng)) {
                return;
              }
              const position = { lat, lng };
              const showInfo = () => {
                const title = card.dataset.title || "予定";
                const address = card.dataset.address || "";
                const url = card.dataset.googleUrl || "";
                const content = `
                  <div style="font-family: 'Space Grotesk', sans-serif;">
                    <strong>${title}</strong><br />
                    ${address ? `<div>${address}</div>` : ""}
                    ${url ? `<a href="${url}" target="_blank" rel="noopener">Googleマップで開く</a>` : ""}
                  </div>
                `;
                infoWindow.setContent(content);
                infoWindow.open(listMap, listMarker);
              };
              card.addEventListener("click", (event) => {
                if (event.target.closest("a, button, form")) {
                  return;
                }
                const day = card.closest(".schedule-day");
                const target = day || card;
                const list = target.parentElement;
                if (list && (mapPanel.parentElement !== list || mapPanel.nextElementSibling !== target)) {
                  list.insertBefore(mapPanel, target);
                }
                mapPanel.classList.add("is-visible");
                listMap.setCenter(position);
                listMap.setZoom(16);
                listMarker.setPosition(position);
                setTimeout(() => {
                  google.maps.event.trigger(listMap, "resize");
                  listMap.setCenter(position);
                }, 200);
                showInfo();
              });
            });

            if (mapClose) {
              mapClose.addEventListener("click", () => {
                mapPanel.classList.remove("is-visible");
                infoWindow.close();
              });
            }
          }

        };

        if (document.readyState === "loading") {
          document.addEventListener("DOMContentLoaded", run, { once: true });
        } else {
          run();
        }
      }
    </script>
    <script
      src="https://maps.googleapis.com/maps/api/js?key={{ google_maps_api_key }}&libraries=places&callback=initScheduleSearch"
      async
      defer
    ></script>
  {% endif %}
{% endblock %}

{% block content %}
  <section class="page-header">
    <div>
      <p class="eyebrow">Schedule</p>
      <h1>予定</h1>
      <p class="lead">日付ごとの予定とタイムラインをまとめる</p>
    </div>
  </section>

  <section class="panel form-panel is-collapsed" id="schedule-form-panel">
    <form method="post" class="form-grid" enctype="multipart/form-data" id="schedule-form">
      <div class="schedule-blocks" data-next-index="1">
        <div class="schedule-block" data-index="0">
          <div>
            <label for="schedule-title-0">タイトル</label>
            <input id="schedule-title-0" name="schedule_title_0" type="text" placeholder="例: 東京ドライブ" class="schedule-title" data-field="title" />
          </div>
          <div>
            <label for="schedule-date-0">日付</label>
            <input id="schedule-date-0" name="schedule_date_0" type="date" class="schedule-date" data-field="date" />
          </div>
          <div>
            <label for="schedule-detail-0">メモ</label>
            <textarea id="schedule-detail-0" name="schedule_detail_0" placeholder="予定のメモ" class="schedule-detail" data-field="detail"></textarea>
          </div>
          <div>
            <label for="schedule-search-input-0">場所を検索</label>
            <input id="schedule-search-input-0" name="schedule_search_0" type="text" placeholder="例: 東京タワー" autocomplete="off" class="schedule-search-input" data-field="search" />
          </div>
          <div>
            <label for="schedule-address-0">住所</label>
            <input id="schedule-address-0" name="schedule_address_0" type="text" class="schedule-address" data-field="address" />
          </div>
          <div>
            <label>地図プレビュー</label>
            <div id="schedule-map-0" class="map-preview schedule-map" data-field="map"></div>
          </div>
          <div>
            <label>写真プレビュー</label>
            <div class="preview-row">
              <img class="place-photo preview is-hidden schedule-photo-preview" alt="プレビュー" data-field="preview" />
              <button type="button" class="preview-more is-hidden schedule-photo-more" data-field="more">
                <span>+</span>
                <span class="schedule-photo-count" data-field="count">0</span>
              </button>
            </div>
          </div>
          <div>
            <label for="schedule-photos-0">写真を追加</label>
            <input id="schedule-photos-0" name="schedule_photos_0" type="file" accept="image/*" multiple class="schedule-photos" data-field="photos" />
          </div>

          <input type="hidden" name="schedule_place_id_0" class="schedule-place-id" data-field="place_id" />
          <input type="hidden" name="schedule_lat_0" class="schedule-lat" data-field="lat" />
          <input type="hidden" name="schedule_lng_0" class="schedule-lng" data-field="lng" />
          <input type="hidden" name="schedule_photo_url_0" class="schedule-photo-url" data-field="photo_url" />
          <input type="hidden" name="schedule_photo_urls_0" class="schedule-photo-urls" data-field="photo_urls" />
          <input type="hidden" name="schedule_photo_refs_0" class="schedule-photo-refs" data-field="photo_refs" />
          <input type="hidden" name="schedule_rating_0" class="schedule-rating" data-field="rating" />
          <input type="hidden" name="schedule_user_ratings_total_0" class="schedule-user-ratings-total" data-field="user_ratings_total" />
          <input type="hidden" name="schedule_website_0" class="schedule-website" data-field="website" />
          <input type="hidden" name="schedule_phone_0" class="schedule-phone" data-field="phone" />
          <input type="hidden" name="schedule_google_url_0" class="schedule-google-url" data-field="google_url" />
          <input type="hidden" name="schedule_opening_hours_0" class="schedule-opening-hours" data-field="opening_hours" />
        </div>
      </div>
      <div class="schedule-actions">
        <button class="button ghost schedule-add" type="button">予定を追加</button>
        <button class="button primary" type="submit">予定を保存</button>
      </div>
</form>
  </section>

  <section class="panel">
    <div class="panel-header">
      <button class="button primary" type="button" id="schedule-form-toggle">追加フォームを開く</button>
    </div>
    <ul class="item-list">
      <li id="schedule-map-panel" class="map-panel">
        <div class="map-header">
          <strong>マップ</strong>
          <button class="button ghost map-close" type="button" id="schedule-map-close">閉じる</button>
        </div>
        <div id="schedule-list-map" class="map-preview"></div>
      </li>
      {% for group in upcoming_groups %}
        <li class="schedule-day">
          <div class="schedule-day-header">
            <strong class="schedule-day-date">{{ group["date_label"] }}</strong>
            <span class="schedule-day-count">{{ group["items"] | length }}件</span>
          </div>
          <div class="schedule-day-cards">
            {% for item in group["items"] %}
              <article class="item-row schedule-card"
                       data-lat="{{ item['lat'] or '' }}"
                       data-lng="{{ item['lng'] or '' }}"
                       data-place-id="{{ item['place_id'] or '' }}"
                       data-title="{{ item['title'] }}"
                       data-address="{{ item['address'] or '' }}"
                       data-google-url="{{ item['google_url'] or '' }}">
                <div class="item-main">
                  <strong>{{ item["title"] }}</strong>
                  <span class="meta">{{ item["date"] }}</span>
                  {% if item["place_id"] %}
                    <div class="meta place-name"
                         data-place-id="{{ item['place_id'] }}"
                         data-fallback="{{ item['address'] or '場所名' }}">{{ item["address"] or "場所名" }}</div>
                  {% elif item["address"] %}
                    <div class="meta">{{ item["address"] }}</div>
                  {% endif %}
                  {% if item["opening_hours"] %}
                    <button type="button" class="button ghost hours-toggle">営業時間を見る</button>
                    <div class="note is-hidden hours-details">{{ item["opening_hours"] }}</div>
                  {% endif %}
                  {% if item["detail"] %}
                    <div class="note">{{ item["detail"] }}</div>
                  {% endif %}
                  {% set photos = photos_by_schedule.get(item["id"], []) %}
                  {% if photos %}
                    <div class="photo-shell">
                      <div class="photo-scroller">
                        {% for photo in photos[:3] %}
                          <img class="place-photo"
                               src="{{ photo['display_url'] }}"
                               alt="{{ item['title'] }}"
                               data-photo-id="{{ photo['id'] or '' }}"
                               data-photo-url="{{ photo['url'] }}"
                               data-schedule-id="{{ item['id'] }}"
                               data-google-photo="{{ '1' if photo['is_google'] else '' }}" />
                        {% endfor %}
                      </div>
                    </div>
                  {% endif %}
                </div>
                <div class="item-actions">
                  {% set search_query = (item["title"] or "") | urlencode %}
                  <a class="button ghost search-link"
                     href="https://www.google.com/search?q={{ search_query }}"
                     data-default-query="{{ item['title'] or '' }}"
                     target="_blank"
                     rel="noopener">検索</a>
                  {% if item["google_url"] %}
                    <a class="button ghost" href="{{ item['google_url'] }}" target="_blank" rel="noopener">地図</a>
                  {% endif %}
                  <a class="button ghost" href="{{ url_for('schedule_edit', schedule_id=item['id']) }}">編集</a>
                  <form method="post" action="{{ url_for('schedule_delete', schedule_id=item['id']) }}">
                    <button class="button danger" type="submit">削除</button>
                  </form>
                </div>
              </article>
            {% endfor %}
          </div>
        </li>
      {% else %}
        <li class="item-row empty-state">まだ予定がありません</li>
      {% endfor %}
    </ul>
  </section>
  <section class="section-title">
    <h2>思い出</h2>
  </section>

  <section class="panel">
    <div class="panel-header">
    </div>
    <ul class="item-list">
      {% for group in past_groups %}
        <li class="schedule-day">
          <div class="schedule-day-header">
            <strong class="schedule-day-date">{{ group["date_label"] }}</strong>
            <span class="schedule-day-count">{{ group["items"] | length }}件</span>
          </div>
          <div class="schedule-day-cards">
            {% for item in group["items"] %}
              <article class="item-row schedule-card"
                       data-lat="{{ item['lat'] or '' }}"
                       data-lng="{{ item['lng'] or '' }}"
                       data-place-id="{{ item['place_id'] or '' }}"
                       data-title="{{ item['title'] }}"
                       data-address="{{ item['address'] or '' }}"
                       data-google-url="{{ item['google_url'] or '' }}">
                <div class="item-main">
                  <strong>{{ item["title"] }}</strong>
                  <span class="meta">{{ item["date"] }}</span>
                  {% if item["place_id"] %}
                    <div class="meta place-name"
                         data-place-id="{{ item['place_id'] }}"
                         data-fallback="{{ item['address'] or '場所名' }}">{{ item["address"] or "場所名" }}</div>
                  {% elif item["address"] %}
                    <div class="meta">{{ item["address"] }}</div>
                  {% endif %}
                  {% if item["opening_hours"] %}
                    <button type="button" class="button ghost hours-toggle">営業時間を見る</button>
                    <div class="note is-hidden hours-details">{{ item["opening_hours"] }}</div>
                  {% endif %}
                  {% if item["detail"] %}
                    <div class="note">{{ item["detail"] }}</div>
                  {% endif %}
                  {% set photos = photos_by_schedule.get(item["id"], []) %}
                  {% if photos %}
                    <div class="photo-shell">
                      <div class="photo-scroller">
                        {% for photo in photos[:3] %}
                          <img class="place-photo"
                               src="{{ photo['display_url'] }}"
                               alt="{{ item['title'] }}"
                               data-photo-id="{{ photo['id'] or '' }}"
                               data-photo-url="{{ photo['url'] }}"
                               data-schedule-id="{{ item['id'] }}"
                               data-google-photo="{{ '1' if photo['is_google'] else '' }}" />
                        {% endfor %}
                      </div>
                    </div>
                  {% endif %}
                </div>
                <div class="item-actions">
                  {% set search_query = (item["title"] or "") | urlencode %}
                  <a class="button ghost search-link"
                     href="https://www.google.com/search?q={{ search_query }}"
                     data-default-query="{{ item['title'] or '' }}"
                     target="_blank"
                     rel="noopener">検索</a>
                  {% if item["google_url"] %}
                    <a class="button ghost" href="{{ item['google_url'] }}" target="_blank" rel="noopener">地図</a>
                  {% endif %}
                  <a class="button ghost" href="{{ url_for('schedule_edit', schedule_id=item['id']) }}">編集</a>
                  <form method="post" action="{{ url_for('schedule_delete', schedule_id=item['id']) }}">
                    <button class="button danger" type="submit">削除</button>
                  </form>
                </div>
              </article>
            {% endfor %}
          </div>
        </li>
      {% else %}
        <li class="item-row empty-state">まだ予定がありません</li>
      {% endfor %}
    </ul>
  </section>
  <div id="schedule-photo-modal" class="photo-modal is-hidden" role="dialog" aria-modal="true">
    <div class="photo-modal-card">
      <div class="photo-modal-header">
        <strong>写真一覧</strong>
        <button type="button" class="button ghost" id="schedule-photo-modal-close">閉じる</button>
      </div>
      <div class="photo-modal-body photo-shell">
        <div class="photo-scroller" id="schedule-photo-modal-scroller"></div>
      </div>
      <form method="post" action="{{ url_for('schedule_photo_delete') }}" id="schedule-photo-delete-form" class="inline-actions is-hidden">
        <input type="hidden" name="photo_id" id="schedule-photo-delete-id" />
        <input type="hidden" name="photo_url" id="schedule-photo-delete-url" />
        <input type="hidden" name="schedule_id" id="schedule-photo-delete-schedule" />
        <button class="button danger" type="submit" data-confirm="false">写真を削除</button>
      </form>
    </div>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const formToggle = document.getElementById("schedule-form-toggle");
      const formPanel = document.getElementById("schedule-form-panel");
      const scheduleBlocks = document.querySelector(".schedule-blocks");
      const scheduleAdd = document.querySelector(".schedule-add");
      if (scheduleBlocks && scheduleAdd) {
        scheduleAdd.addEventListener("click", () => {
          const template = scheduleBlocks.querySelector(".schedule-block");
          if (!template) return;
          const nextIndex = Number(scheduleBlocks.dataset.nextIndex || "1");
          const clone = template.cloneNode(true);
          clone.dataset.index = String(nextIndex);
          const fields = clone.querySelectorAll("[data-field]");
          fields.forEach((fieldEl) => {
            const field = fieldEl.dataset.field || "";
            const id = `schedule-${field}-${nextIndex}`;
            if (fieldEl.tagName === "INPUT" || fieldEl.tagName === "TEXTAREA") {
              if (field === "photos") {
                fieldEl.name = `schedule_photos_${nextIndex}`;
              } else {
                fieldEl.name = `schedule_${field}_${nextIndex}`;
              }
              fieldEl.id = id;
              if (fieldEl.type !== "file") {
                fieldEl.value = "";
              } else {
                fieldEl.value = "";
              }
            } else {
              fieldEl.id = id;
            }
            const label = fieldEl.closest("div")?.querySelector("label");
            if (label) {
              label.htmlFor = id;
            }
          });
          const previewImg = clone.querySelector(".schedule-photo-preview");
          if (previewImg) {
            previewImg.classList.add("is-hidden");
            previewImg.removeAttribute("src");
          }
          const previewMore = clone.querySelector(".schedule-photo-more");
          if (previewMore) {
            previewMore.classList.add("is-hidden");
            delete previewMore.dataset.photos;
          }
          const previewCount = clone.querySelector(".schedule-photo-count");
          if (previewCount) previewCount.textContent = "0";
          scheduleBlocks.appendChild(clone);
          scheduleBlocks.dataset.nextIndex = String(nextIndex + 1);
          if (typeof window.__initScheduleBlock === "function") {
            window.__initScheduleBlock(clone);
          } else {
            window.__pendingScheduleBlocks = window.__pendingScheduleBlocks || [];
            window.__pendingScheduleBlocks.push(clone);
          }
        });
      }
      if (formToggle && formPanel) {
        formToggle.addEventListener("click", () => {
          const isHidden = formPanel.classList.toggle("is-collapsed");
          formToggle.textContent = isHidden ? "追加フォームを開く" : "追加フォームを閉じる";
          if (!isHidden) {
            formPanel.scrollIntoView({ behavior: "smooth", block: "start" });
          }
        });
      }

      const hourButtons = document.querySelectorAll(".hours-toggle");
      hourButtons.forEach((button) => {
        button.addEventListener("click", () => {
          const details = button.closest(".item-main")?.querySelector(".hours-details");
          if (!details) return;
          const isHidden = details.classList.toggle("is-hidden");
          button.textContent = isHidden ? "営業時間を見る" : "営業時間を隠す";
        });
      });

      const refreshScheduleDetails = () => {
        const nameService = new google.maps.places.PlacesService(document.createElement("div"));
        const placeNameEls = document.querySelectorAll(".place-name[data-place-id]");
        placeNameEls.forEach((el) => {
          const placeId = el.dataset.placeId;
          if (!placeId) return;
          nameService.getDetails({ placeId, fields: ["name", "photos"] }, (details, status) => {
            if (status === google.maps.places.PlacesServiceStatus.OK && details?.name) {
              el.textContent = details.name;
              const card = el.closest(".schedule-card");
              const searchLink = card?.querySelector(".search-link");
              if (searchLink) {
                searchLink.href = `https://www.google.com/search?q=${encodeURIComponent(details.name)}`;
              }
              return;
            }
            const fallback = el.dataset.fallback || "";
            if (fallback) {
              el.textContent = fallback;
            }
          });
        });
      };
      window.__refreshScheduleDetails = refreshScheduleDetails;
      if (window.google && google.maps && google.maps.places) {
        refreshScheduleDetails();
      } else {
        window.__refreshScheduleDetailsPending = true;
      }

      const extractPhotoReference = (url) => {
        if (!url) return "";
        const refParam = url.match(/[?&]photo_reference=([^&]+)/);
        if (refParam && refParam[1]) {
          return decodeURIComponent(refParam[1]);
        }
        const refLegacy = url.match(/[?&]1s([^&]+)/);
        if (refLegacy && refLegacy[1]) {
          return decodeURIComponent(refLegacy[1]);
        }
        return "";
      };

      const refreshSchedulePhotos = () => {
        const apiKey = "{{ google_maps_api_key or '' }}";
        if (!apiKey) return;
        const imgs = Array.from(document.querySelectorAll("img.place-photo[data-google-photo='1']"));
        imgs.forEach((img) => {
          const storedUrl = img.dataset.photoUrl || "";
          const ref = extractPhotoReference(storedUrl);
          if (!ref) return;
          img.src = `https://maps.googleapis.com/maps/api/place/photo?maxwidth=600&photo_reference=${encodeURIComponent(ref)}&key=${apiKey}`;
        });
      };
      refreshSchedulePhotos();

      const modal = document.getElementById("schedule-photo-modal");
      const modalClose = document.getElementById("schedule-photo-modal-close");
      const modalScroller = document.getElementById("schedule-photo-modal-scroller");
      const previewMoreButtons = document.querySelectorAll(".schedule-photo-more");
      const deleteForm = document.getElementById("schedule-photo-delete-form");
      const deleteId = document.getElementById("schedule-photo-delete-id");
      const deleteUrl = document.getElementById("schedule-photo-delete-url");
      const deleteSchedule = document.getElementById("schedule-photo-delete-schedule");
      if (modal && modalClose && modalScroller) {
        previewMoreButtons.forEach((previewMore) => {
          previewMore.addEventListener("click", () => {
            const list = previewMore.dataset.photos || "[]";
          let urls = [];
          try {
            urls = JSON.parse(list);
          } catch (e) {
            urls = [];
          }
          modalScroller.innerHTML = "";
          urls.forEach((url) => {
            const img = document.createElement("img");
            img.className = "place-photo preview";
            img.src = url;
            img.alt = "プレビュー";
            modalScroller.appendChild(img);
          });
          if (deleteForm) {
            deleteForm.classList.add("is-hidden");
          }
          modal.classList.remove("is-hidden");
          });
        });
        modalClose.addEventListener("click", () => {
          modal.classList.add("is-hidden");
        });
        modal.addEventListener("click", (event) => {
          if (event.target === modal) {
            modal.classList.add("is-hidden");
          }
        });
      }

      const listPhotos = document.querySelectorAll(".schedule-card .place-photo[data-schedule-id]");
      listPhotos.forEach((img) => {
        img.addEventListener("click", (event) => {
          event.stopPropagation();
          if (!modal || !modalScroller) return;
          modalScroller.innerHTML = "";
          const photo = document.createElement("img");
          photo.className = "place-photo preview";
          photo.src = img.src;
          photo.alt = img.alt || "写真";
          modalScroller.appendChild(photo);
          if (deleteForm && deleteId && deleteUrl && deleteSchedule) {
            deleteId.value = img.dataset.photoId || "";
            deleteUrl.value = img.dataset.photoUrl || "";
            deleteSchedule.value = img.dataset.scheduleId || "";
            deleteForm.classList.remove("is-hidden");
          }
          modal.classList.remove("is-hidden");
        });
      });
    });
  </script>
{% endblock %}
